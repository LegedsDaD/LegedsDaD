name: Animated GitHub Stats Cards

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch GitHub Stats
        run: |
          USER="LegedsDaD"

          FOLLOWERS=$(curl -s https://api.github.com/users/$USER | jq '.followers')
          REPOS=$(curl -s https://api.github.com/users/$USER/repos?per_page=100)

          STARS=$(echo "$REPOS" | jq '[.[].stargazers_count] | add')
          if [ "$STARS" = "null" ]; then STARS=0; fi

          LANG=$(echo "$REPOS" | jq -r '.[].language' | grep -v null | sort | uniq -c | sort -nr | head -1 | awk '{print $2}')
          if [ -z "$LANG" ]; then LANG="None"; fi

          VISITORS=$(curl -s https://api.countapi.xyz/hit/legedsdad/profile | jq '.value')

          echo "FOLLOWERS=$FOLLOWERS" >> $GITHUB_ENV
          echo "STARS=$STARS" >> $GITHUB_ENV
          echo "LANG=$LANG" >> $GITHUB_ENV
          echo "VISITORS=$VISITORS" >> $GITHUB_ENV

      - name: Create SVG File
        run: |
          echo '<svg width="700" height="320" xmlns="http://www.w3.org/2000/svg">' > cards.svg
          echo '<rect width="100%" height="100%" fill="#0d1117"/>' >> cards.svg
          echo '<style>.title{font:bold 28px monospace;fill:#58a6ff}.stat{font:bold 22px monospace;fill:white}</style>' >> cards.svg
          echo '<text x="40" y="60" class="title">GitHub Stats</text>' >> cards.svg
          echo "<text x='40' y='120' class='stat'>Visitors: $VISITORS</text>" >> cards.svg
          echo "<text x='40' y='160' class='stat'>Stars: $STARS</text>" >> cards.svg
          echo "<text x='40' y='200' class='stat'>Followers: $FOLLOWERS</text>" >> cards.svg
          echo "<text x='40' y='240' class='stat'>Language: $LANG</text>" >> cards.svg
          echo '</svg>' >> cards.svg

      - name: Push to output branch
        run: |
          git config user.name github-actions
          git config user.email actions@github.com

          git fetch origin

          git checkout output || git checkout -b output

          mv cards.svg .

          git add cards.svg
          git commit -m "Update GitHub stats card" || echo "No changes"

          git push origin output --force
